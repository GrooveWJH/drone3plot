# 平面控制调试指南

## 问题现象

用户反馈即使启用了增益调度和Smith预测器，无人机仍然存在超调问题（飞过目标点才减速）。

## 调试输出说明

现在 `main_plane.py` 会每10个循环打印一次详细信息，帮助你诊断问题：

### 输出格式

```
#0010 | WP0 | 目标(+1.00,+0.50) | 当前(+0.35,+0.22) | 距 78.3cm | Kp×1.00 Kd×0.50 | Out:P+250/R-120 | X(P+280/I-20/D-10) | Y(P-100/I-15/D-5) | Smith[X:25/Y:25]
```

### 字段解释

| 字段 | 含义 | 正常值 | 问题诊断 |
|------|------|--------|----------|
| `#0010` | 循环计数器 | 递增 | - |
| `WP0` | 当前航点索引 | 0~N | - |
| `目标(x,y)` | 目标坐标(米) | 配置值 | - |
| `当前(x,y)` | 当前坐标(米) | SLAM反馈 | 检查是否跳变 |
| `距XXcm` | 距离误差(厘米) | 递减到5cm内 | 如果一直很大说明控制无效 |
| `Kp×X.XX Kd×X.XX` | **增益调度系数** | 远处1.0/0.5，近处0.4/1.5 | **重点观察！** |
| `Out:P+X/R+X` | PID输出(杆量偏移) | ±450以内 | 检查是否饱和 |
| `X(P/I/D)` | X轴PID三个分量 | P主导，I小，D适中 | D很大说明速度快 |
| `Y(P/I/D)` | Y轴PID三个分量 | 同上 | 同上 |
| `Smith[X:N/Y:N]` | **Smith缓冲区大小** | 25左右(500ms@50Hz) | **检查是否工作** |

## 关键诊断点

### 1. 增益调度是否工作？

**预期行为**：
- 距离 > 1.0m 时：`Kp×1.00 Kd×0.50` （激进）
- 距离 0.3~1.0m 时：`Kp×0.40~1.00 Kd×0.50~1.50` （线性过渡）
- 距离 < 0.3m 时：`Kp×0.40 Kd×1.50` （保守）

**如果问题**：
- 增益系数不变（始终1.00/1.00） → 增益调度未启用或逻辑错误
- 距离很近了还是1.00/0.50 → 距离阈值设置不合理

### 2. Smith预测器是否工作？

**预期行为**：
- `Smith[X:25/Y:25]` 表示缓冲区有25个历史指令（500ms延迟@50Hz控制频率）
- 缓冲区大小应该稳定在 `estimated_delay * control_frequency` 左右

**如果问题**：
- `Smith[X:0/Y:0]` → Smith预测器未启用或清空了缓冲区
- 数字太小（<10）→ `PLANE_ESTIMATED_DELAY` 设置太小
- 数字太大（>50）→ `PLANE_ESTIMATED_DELAY` 设置太大

### 3. PID输出分析

**正常模式**：
- **远离目标时**：P分量很大（主导），I分量小，D分量中等
- **接近目标时**：P分量减小，D分量增大（刹车效应）
- **超调时**：P和I同号且都很大，D反向但不足以抵消

**如果超调**：
- D分量始终很小 → Kd增益太小或增益调度未生效
- D分量很大但输出仍大 → P/I分量过大，压制了D的作用
- 接近目标时P分量还很大 → 增益调度的Kp缩放不够

## 调参建议

### 场景1：增益调度不工作

**症状**：
- 增益系数始终是 `Kp×1.00 Kd×1.00`
- 即使很接近目标，系数也不变

**检查**：
```python
# config.py
PLANE_ENABLE_GAIN_SCHEDULING = True  # 是否为True?
PLANE_DISTANCE_FAR = 1.0             # 远距离阈值
PLANE_DISTANCE_NEAR = 0.3            # 近距离阈值
```

**解决**：
- 确保 `PLANE_ENABLE_GAIN_SCHEDULING = True`
- 如果距离阈值不合理，调整 `PLANE_DISTANCE_FAR` 和 `PLANE_DISTANCE_NEAR`

### 场景2：增益调度工作但仍超调

**症状**：
- 增益系数正确变化（远处1.0/0.5，近处0.4/1.5）
- 但无人机还是冲过目标

**原因**：
- 网络延迟500ms，Smith预测器补偿不足
- 或者基础PID参数本身就太激进

**解决方案A：调整Smith预测器参数**
```python
# config.py
PLANE_ESTIMATED_DELAY = 0.6  # 增加延迟估计（如果网络更慢）
PLANE_RESPONSE_GAIN = 0.002  # 增加响应增益（加强补偿）
```

**解决方案B：降低基础PID增益**
```python
# config.py
KP_XY = 250.0  # 从300降低
KI_XY = 25.0   # 从30降低
KD_XY = 120.0  # 从100增加
```

**解决方案C：调整增益调度策略**
```python
# controller.py: _apply_gain_scheduling()
# 把远距离的Kp缩放改小
if distance > self.distance_far:
    kp_scale = 0.8  # 改为0.8（原来1.0）
    kd_scale = 0.6  # 改为0.6（原来0.5）
```

### 场景3：Smith预测器不工作

**症状**：
- `Smith[X:0/Y:0]` 或数字很小
- 缓冲区没有积累历史指令

**检查**：
```python
# config.py
PLANE_ENABLE_SMITH_PREDICTOR = True  # 是否为True?
PLANE_ESTIMATED_DELAY = 0.5          # 延迟估计（秒）
```

**解决**：
- 确保 `PLANE_ENABLE_SMITH_PREDICTOR = True`
- 检查 controller.py 中 `_apply_smith_predictor()` 逻辑

### 场景4：基础PID太激进

**症状**：
- PID输出经常饱和（Out:P+450/R+450）
- D分量虽然大，但总输出还是很大

**解决**：
```python
# config.py
KP_XY = 200.0  # 大幅降低P
KI_XY = 20.0   # 降低I
KD_XY = 150.0  # 增加D
```

## 实验流程

### 第1步：验证增益调度

1. 启动控制程序
2. 观察打印输出中的 `Kp×X.XX Kd×X.XX`
3. 记录不同距离下的增益系数

**预期结果**：
- 远处（>1m）：Kp×1.0, Kd×0.5
- 中等（0.3~1m）：逐渐过渡
- 近处（<0.3m）：Kp×0.4, Kd×1.5

**如果不符合预期** → 增益调度有问题，检查代码

### 第2步：验证Smith预测器

1. 观察 `Smith[X:N/Y:N]` 的数字
2. 计算：`N ≈ PLANE_ESTIMATED_DELAY * CONTROL_FREQUENCY`
3. 例如：0.5秒 × 50Hz = 25

**预期结果**：
- 缓冲区大小稳定在25左右

**如果数字是0或很小** → Smith预测器未工作

### 第3步：观察PID分量

重点关注接近目标时（距离<50cm）的PID分量：

**正常情况**：
```
距 45.0cm | Kp×0.45 Kd×1.45 | Out:P+120/R-80 | X(P+150/I-10/D-20) | Y(P-90/I-5/D+5)
距 30.0cm | Kp×0.42 Kd×1.48 | Out:P+80/R-50 | X(P+100/I-5/D-15) | Y(P-60/I-3/D+7)
距 15.0cm | Kp×0.40 Kd×1.50 | Out:P+30/R-20 | X(P+50/I-3/D-17) | Y(P-30/I-2/D+8)
```
→ P逐渐减小，D逐渐增大，输出逐渐减小

**超调情况**：
```
距 45.0cm | Kp×0.45 Kd×1.45 | Out:P+300/R-250 | X(P+320/I-15/D-5) | Y(P-260/I-8/D+2)
距 30.0cm | Kp×0.42 Kd×1.48 | Out:P+280/R-230 | X(P+300/I-12/D-8) | Y(P-240/I-6/D+4)
```
→ P还很大，D很小，输出没有明显减小 → **问题在这里！**

### 第4步：根据数据调整参数

根据第3步的观察：

**如果D分量太小**：
```python
KD_XY = 150.0  # 从100增加到150
```

**如果P分量太大**：
```python
KP_XY = 250.0  # 从300降低到250
```

**如果增益调度Kp缩放不够**（接近目标时Kp还是很大）：
```python
# 在controller.py修改近距离的kp_scale
else:
    kp_scale = 0.3  # 改为0.3（原来0.4）
    kd_scale = 1.8  # 改为1.8（原来1.5）
```

## 快速诊断命令

运行控制程序时，用grep过滤关键信息：

```bash
# 只看距离和增益调度
python -m apps.control.main_plane 2>&1 | grep "距" | grep "Kp×"

# 只看Smith缓冲区
python -m apps.control.main_plane 2>&1 | grep "Smith"

# 只看接近目标时的数据（距离<50cm）
python -m apps.control.main_plane 2>&1 | grep "距.*[0-4][0-9]\.[0-9]cm"
```

## 总结

你的控制系统有3层保护：
1. **增益调度**：根据距离调整PID增益
2. **Smith预测器**：补偿500ms网络延迟
3. **基础PID**：核心控制算法

如果还是超调，按这个顺序排查：
1. ✅ 确认增益调度工作（观察Kp×/Kd×系数变化）
2. ✅ 确认Smith预测器工作（观察Smith缓冲区大小）
3. ✅ 分析PID分量（找出哪个分量导致超调）
4. 🔧 根据分析结果调整参数

现在运行程序，把打印输出发给我，我可以帮你分析！
